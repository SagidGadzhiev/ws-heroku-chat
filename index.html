<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="./index.css">
</head>

<body onload="Init()">

<ul id="messages-list" class="all-messages"></ul>

<form id="form" class="main-form">
    <label id="login-label" class="form-label">
        <input id="username" class="label-input" type="text" placeholder="Ваше имя...">
        <button id="log-in" class="label-btn" onclick="login()">Войти</button>
    </label>
    <label id="message-label" class="form-label">
        <input id="text-message" class="label-input" type="text" placeholder="Введите сообщение...">
        <button id="send-message" class="label-btn" type="submit" onclick="sendHandler()">Отправить</button>
    </label>
</form>

<script>

    const user_id = Date.now();

    function Init() {
        document.getElementById('username').focus()
    }

    const host = location.origin.replace(/^http/, 'ws');
    const ws = new WebSocket(host);
    // const ws = new WebSocket('ws://localhost:5000/');

    document.getElementById('message-label').hidden = true;

    const form = document.getElementById('form');
    form.addEventListener('submit', (e) => {
        e.preventDefault();
    }, true);

    const login = () => {
        let username = document.getElementById('username');

        const messageData = {
            id: Date.now(),
            event: 'connect',
            username: username.value === '' ? 'Неизвестный пользователь' : username.value
        };

        ws.send(JSON.stringify(messageData));

        document.getElementById('message-label').hidden = false;
        document.getElementById('login-label').hidden = true;
        document.getElementById('log-in').type = 'button';

    };

    const sendHandler = () => {
        let username = document.getElementById('username');
        let textMessage = document.getElementById('text-message');

        const messageData = {
            id: Date.now(),
            user_id,
            event: 'message',
            username: username.value === '' ? 'Неизвестный пользователь' : username.value,
            textMessage: textMessage.value
        };

        ws.send(JSON.stringify(messageData));
        textMessage.value = '';
    };

    ws.onmessage = (event) => {

        const wsMessage = JSON.parse(event.data);

        let ul = document.getElementById('messages-list');
        let li = document.createElement('li');
        let span = document.createElement('span');

        if (wsMessage.event === 'message') {
            if (wsMessage.user_id === user_id) {
                li.classList.add('li-message-mi')
                span.classList.add('span-mi')
                span.innerHTML = `${wsMessage.textMessage}`
                li.appendChild(span)
                // li.innerHTML = `${wsMessage.textMessage}`
            } else {
                li.classList.add('li-message-friend')
                span.classList.add('span-friend')
                span.innerHTML = `${wsMessage.username}: ${wsMessage.textMessage}`
                li.appendChild(span)
                // li.innerHTML = `${wsMessage.username}: ${wsMessage.textMessage}`
            }
        } else {
            li.innerHTML = `Пользователь ${wsMessage.username} подключился`
            li.classList.add('li-connect')
        }

        ul.appendChild(li);
    };

</script>

</body>
</html>
